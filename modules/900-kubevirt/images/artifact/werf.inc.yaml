# Source https://github.com/kubevirt/kubevirt/blob/main/hack/dockerized#L15
{{- $builderImage := "quay.io/kubevirt/builder:2206141426-2d31aa580" }}
{{- $version := "0.55.0" }}

artifact: {{ $.ModuleName }}/{{ $.ImageName }}
from: quay.io/kubevirt/builder:2206141426-2d31aa580
git:
  - add: /modules/900-{{ $.ModuleName }}/images/{{ $.ImageName }}
    to: /
    stageDependencies:
      setup:
      - '**/*'
    includePaths:
    - patches
    - unpack-bundle.sh
shell:
  setup:
  - git clone --branch v{{ $version }} https://github.com/kubevirt/kubevirt /kubevirt
  - git -C /kubevirt apply /patches/*.patch
  - mkdir -p /kubevirt/_out
  - make -C /kubevirt bazel-build-image-bundle KUBEVIRT_RUN_UNNESTED=true
  - tar --one-top-level -xf /kubevirt/_out/virt-components-bundle.tar
  - mkdir -p /images && cd /images && /unpack-bundle.sh /virt-components-bundle/
